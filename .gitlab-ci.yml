stages:
- build
- report

variables:
  ETOPDIR: /etop.vn
  POSTGRES_USER: postgres
  POSTGRES_DB: test
  POSTGRES_PASSWORD: postgres

before_script:
- mkdir -p artifacts
- mkdir -p /etop.vn
- ln -s $PWD /etop.vn/backend

build:
  stage: build
  tags: [go]
  image: golang:1.12
  except:
  - master
  - ci/master
  - /^changes/
  services:
  - postgres:9.6-alpine
  - redis:alpine
  script:
  - scripts/ci/cache-load.sh
  - scripts/verify-imports.sh
  - scripts/build-linux.sh
  - go run ./scripts/init_testdb/main.go -drop
  - go test -v -race $(go list ./... | grep -v '/tests/')
  - scripts/ci/cache-save.sh
  cache:
    key: "ci:$CI_JOB_NAME"
    paths:
    - .mod/
  artifacts:
    paths:
    - artifacts/

build-master:
  stage: build
  tags: [go]
  image: golang:1.12
  only:
  - master
  - ci/master
  services:
  - postgres:9.6-alpine
  - redis:alpine
  script:
  - scripts/ci/cache-load.sh
  - scripts/verify-imports.sh
  - scripts/build-linux.sh
  - go run ./scripts/init_testdb/main.go -drop
  - scripts/ci/test-cover.sh
  - scripts/ci/show-coverage.sh
  - scripts/ci/cache-save.sh
  cache:
    key: "ci:$CI_JOB_NAME"
    paths:
    - .mod/
  artifacts:
    paths:
    - artifacts/

build-gerrit-changes:
  stage: build
  tags: [go]
  image: golang:1.12
  only:
  - /^changes\/[0-9]{2}\/[0-9]+\/[0-9]+$/
  services:
  - postgres:9.6-alpine
  - redis:alpine
  script:
  - scripts/ci/cache-load.sh
  - scripts/verify-imports.sh
  - scripts/build-linux.sh
  - go run ./scripts/init_testdb/main.go -drop
  - go test -v -race $(go list ./... | grep -v '/tests/' | grep -v '/gogen') # TODO: remove gogen
  - scripts/ci/cache-save.sh
  - touch artifacts/BUILD_SUCCESS
  cache:
    key: "ci:$CI_JOB_NAME"
    paths:
    - .mod/
  artifacts:
    paths:
    - artifacts/

report-gerrit-changes:
  stage: report
  when: always
  tags: [go]
  image: bizongroup/alpine-curl-bash
  only:
  - /^changes\/[0-9]{2}\/[0-9]+\/[0-9]+$/
  before_script: []
  script:
  - scripts/ci/report-gerrit.sh
  artifacts:
    paths:
    - artifacts/
