syntax = "proto2";
package etop.vn.api.main.shipnow.v1;
option go_package = "v1";

import "gogoproto/gogo.proto";
option (gogoproto.equal_all)                = false;
option (gogoproto.gogoproto_import)         = false;
option (gogoproto.goproto_enum_prefix_all)  = false;
option (gogoproto.goproto_getters_all)      = true;
option (gogoproto.goproto_sizecache_all)    = false;
option (gogoproto.goproto_unkeyed_all)      = false;
option (gogoproto.goproto_unrecognized_all) = false;
option (gogoproto.gostring_all)             = false;
option (gogoproto.marshaler_all)            = false;
option (gogoproto.onlyone_all)              = false;
option (gogoproto.sizer_all)                = false;
option (gogoproto.testgen_all)              = false;
option (gogoproto.unmarshaler_all)          = false;
option (gogoproto.verbose_equal_all)        = false;

import "etop.vn/api/main/ordering/v1/types/types.proto";
import "etop.vn/api/main/shipping/v1/types/tryon.proto";
import "etop.vn/api/main/shipping/v1/types/types.proto";
import "etop.vn/api/main/shipping/v1/types/feeline.proto";
import "etop.vn/api/meta/v1/api.proto";
import "etop.vn/api/main/etop/v1/status5.proto";
import "etop.vn/api/main/etop/v1/status3.proto";
import "etop.vn/api/main/etop/v1/status4.proto";
import "etop.vn/api/main/shipnow/v1/types/state.proto";
import "etop.vn/api/main/shipnow/v1/types/types.proto";
import "etop.vn/api/main/shipnow/carrier/v1/carrier.proto";

service ShipnowQueryService {
    rpc GetShipnowFulfillment (GetShipnowFulfillmentQueryArgs) returns (GetShipnowFulfillmentQueryResult);
    rpc GetShipnowFulfillments (GetShipnowFulfillmentsQueryArgs) returns (GetShipnowFulfillmentsQueryResult);
    rpc GetShipnowFulfillmentByShippingCode(GetShipnowFulfillmentByShippingCodeQueryArgs) returns (GetShipnowFulfillmentQueryResult);
}

message ShipnowFulfillment {
    optional int64 id = 1 [(gogoproto.nullable)=false];

    optional int64 shop_id = 2 [(gogoproto.nullable)=false];

    optional int64 partner_id = 3 [(gogoproto.nullable)=false];

    optional ordering.v1.types.Address pickup_address = 4;

    repeated types.DeliveryPoint delivery_points = 5;

    optional shipnow.carrier.v1.carrier.Carrier carrier = 6 [(gogoproto.nullable)=false];

    optional string shipping_service_code = 7 [(gogoproto.nullable)=false];

    optional int32 shipping_service_fee = 8 [(gogoproto.nullable)=false];

    optional string shipping_service_name = 28 [(gogoproto.nullable) = false];

    optional shipping.v1.types.WeightInfo weight_info = 9 [(gogoproto.nullable)=false, (gogoproto.embed)=true];

    optional shipping.v1.types.ValueInfo value_info = 10 [(gogoproto.nullable)=false];

    optional string shipping_note = 11 [(gogoproto.nullable)=false];

    optional meta.v1.Timestamp request_pickup_at = 12;

    optional etop.v1.status5.Status5 status = 13 [(gogoproto.nullable)=false];

    optional etop.v1.status5.Status5 shipping_status = 14 [(gogoproto.nullable)=false];

    optional string shipping_code = 15 [(gogoproto.nullable) = false];

    optional shipnow.v1.state.State shipping_state = 16 [(gogoproto.nullable) = false];

    optional etop.v1.status3.Status3 confirm_status = 17 [(gogoproto.nullable) = false];

    repeated int64 order_ids = 18;

    optional meta.v1.Timestamp shipping_created_at = 19;

    optional meta.v1.Timestamp created_at = 20;

    optional meta.v1.Timestamp updated_at = 21;

    optional etop.v1.status4.Status4 etop_payment_status = 22 [(gogoproto.nullable) = false];

    optional meta.v1.Timestamp cod_etop_transfered_at = 23;

    optional meta.v1.Timestamp shipping_picking_at = 24;

    optional meta.v1.Timestamp shipping_delivering_at = 25;

    optional meta.v1.Timestamp shipping_delivered_at = 26;

    optional meta.v1.Timestamp shipping_cancelled_at = 27;

    optional string shipping_shared_link = 29 [(gogoproto.nullable) = false];

    optional string cancel_reason = 30 [(gogoproto.nullable) = false];
}

//-- Commands --//

message CreateShipnowFulfillmentCommand {
    repeated int64 order_ids = 1 [(gogoproto.nullable) = false];

    optional shipnow.carrier.v1.carrier.Carrier carrier = 2 [(gogoproto.nullable)=false];

    optional int64 shop_id = 3 [(gogoproto.nullable) = false];

    optional string shipping_service_code = 4 [(gogoproto.nullable)=false];

    optional int32 shipping_service_fee = 5 [(gogoproto.nullable)=false];

    optional string shipping_note = 6 [(gogoproto.nullable)=false];

    optional meta.v1.Timestamp request_pickup_at = 7;

    optional ordering.v1.types.Address pickup_address = 8;
}

message UpdateShipnowFulfillmentCommand {
    optional int64 id = 1 [(gogoproto.nullable) = false];

    repeated int64 order_ids = 2 [(gogoproto.nullable) = false];

    optional shipnow.carrier.v1.carrier.Carrier carrier = 3 [(gogoproto.nullable)=false];

    optional int64 shop_id = 4 [(gogoproto.nullable) = false];

    optional string shipping_service_code = 5 [(gogoproto.nullable)=false];

    optional int32 shipping_service_fee = 6 [(gogoproto.nullable)=false];

    optional string shipping_note = 7 [(gogoproto.nullable)=false];

    optional meta.v1.Timestamp request_pickup_at = 8;

    optional ordering.v1.types.Address pickup_address = 9;
}

message ConfirmShipnowFulfillmentCommand {
    optional int64 id = 1 [(gogoproto.nullable)=false];
    optional int64 shop_id = 2 [(gogoproto.nullable) = false];
}

message CancelShipnowFulfillmentCommand {
    optional int64 id = 1 [(gogoproto.nullable)=false];
    optional int64 shop_id = 2 [(gogoproto.nullable) = false];
    optional string cancel_reason = 3 [(gogoproto.nullable)=false];
}

message UpdateShipnowFulfillmentCarrierInfoCommand {
    optional int64 id = 1 [(gogoproto.nullable) = false];
    optional string shipping_code = 2 [(gogoproto.nullable) = false];
    optional shipnow.v1.state.State shipping_state = 3 [(gogoproto.nullable) = false];
    optional int32 total_fee = 4 [(gogoproto.nullable) = false];
    repeated shipping.v1.types.FeeLine fee_lines = 5;
    repeated shipping.v1.types.FeeLine carrier_fee_lines = 6;
    optional meta.v1.Timestamp shipping_created_at = 7;
    optional etop.v1.status4.Status4 etop_payment_status = 8 [(gogoproto.nullable) = false];
    optional etop.v1.status5.Status5 shipping_status = 9 [(gogoproto.nullable) = false];
    optional etop.v1.status5.Status5 status = 10 [(gogoproto.nullable) = false];

    optional meta.v1.Timestamp cod_etop_transfered_at = 11;
    optional meta.v1.Timestamp shipping_picking_at = 12;
    optional meta.v1.Timestamp shipping_delivering_at = 13;
    optional meta.v1.Timestamp shipping_delivered_at = 14;
    optional meta.v1.Timestamp shipping_cancelled_at = 15;

    optional string shipping_service_name = 16 [(gogoproto.nullable) = false];
    optional string cancel_reason = 17 [(gogoproto.nullable) = false];
    optional string shipping_shared_link = 18 [(gogoproto.nullable) = false];
}

message UpdateShipnowFulfullmentStateCommand {
    optional int64 id = 1 [(gogoproto.nullable) = false];
    optional etop.v1.status4.Status4 sync_status = 2 [(gogoproto.nullable)= false];
    optional etop.v1.status5.Status5 status = 3 [(gogoproto.nullable) = false];
    optional etop.v1.status3.Status3 confirm_status = 4 [(gogoproto.nullable) = false];
    optional etop.v1.status5.Status5 shipping_status = 5 [(gogoproto.nullable) = false];
    optional SyncStates sync_states = 6;
    optional shipnow.v1.state.State shipping_state = 7 [(gogoproto.nullable) = false];
}

message SyncStates {
    optional meta.v1.Timestamp sync_at = 1;
    optional meta.v1.Timestamp try_sync_at = 2;
    optional meta.v1.Error error = 3;
}

message GetShipnowServicesCommand {
    optional int64 shop_id = 1 [(gogoproto.nullable) = false];
    repeated int64 order_ids = 2;
    optional ordering.v1.types.Address pickup_address = 3;
    repeated types.DeliveryPoint delivery_points = 4;
}

message GetShipnowServicesCommandResult {
    repeated shipnow.v1.types.ShipnowService services = 1;
}

//-- Queries --//

message GetShipnowFulfillmentQueryArgs {
    optional int64 id = 1 [(gogoproto.nullable)=false];
    optional int64 shop_id = 2 [(gogoproto.nullable) = false];
}

message GetShipnowFulfillmentsQueryArgs {
    repeated int64 shop_ids = 1 [(gogoproto.nullable) = false];
    optional meta.v1.Paging paging = 2;
    repeated meta.v1.Filter filters = 3;
}

message GetShipnowFulfillmentQueryResult {
    optional ShipnowFulfillment shipnow_fulfillment = 1;
}

message GetShipnowFulfillmentsQueryResult {
    repeated ShipnowFulfillment shipnow_fulfillments = 1;
    optional int32 count = 2 [(gogoproto.nullable) = false];
}

message GetShipnowFulfillmentByShippingCodeQueryArgs {
    optional string shipping_code = 1 [(gogoproto.nullable) = false];
}

//-- Events --//

message ShipnowEvent {
    optional int64 id = 1 [(gogoproto.nullable)=false];

    optional meta.v1.UUID uuid = 2 [(gogoproto.nullable)=false];

    optional meta.v1.UUID correlation_id = 3 [(gogoproto.nullable)=false];

    optional int64 shipnow_fulfillment_id = 4 [(gogoproto.nullable)=false];

    optional int32 type = 10 [(gogoproto.nullable)=false];

    optional EventData data = 11;
}

message EventData {
    oneof data {
        CreatedData Created = 1;

        ConfirmationRequestedData ConfirmationRequested = 4;
        ConfirmationAcceptedData  ConfirmationAccepted  = 5;
        ConfirmationRejectedData  ConfirmationRejected  = 6;

        CancellationRequestedData CancellationRequested = 7;
        CancellationAcceptedData  CancellationAccepted  = 8;
        CancellationRejectedData  CancellationRejected  = 9;
    }
}

message CreatedData {
}

message ConfirmationRequestedData {
}

message ConfirmationAcceptedData {
}

message ConfirmationRejectedData {
}

message CancellationRequestedData {
}

message CancellationAcceptedData {
}

message CancellationRejectedData {
}

message ShipnowOrderReservationEvent {
    optional int64 shipnow_fulfillment_id = 1 [(gogoproto.nullable) = false];
    repeated int64 order_ids = 2;
}

message ShipnowOrderChangedEvent {
    optional int64 shipnow_fulfillment_id = 1 [(gogoproto.nullable) = false];
    repeated int64 old_order_ids = 2;
    repeated int64 order_ids = 3;
}

message ShipnowCancelledEvent {
    optional int64 shipnow_fulfillment_id = 1 [(gogoproto.nullable) = false];
    repeated int64 order_ids = 2;
    optional string external_shipnow_id = 3 [(gogoproto.nullable) = false];
    optional string carrier_service_code = 4 [(gogoproto.nullable) = false];
    optional string cancel_reason = 5 [(gogoproto.nullable) = false];
}

message ShipnowValidatedConfirmedEvent {
    optional int64 shipnow_fulfillment_id = 1 [(gogoproto.nullable) = false];
    repeated int64 order_ids = 3;
}

message ShipnowCreateExternalEvent {
    optional int64 shipnow_fulfillment_id = 1 [(gogoproto.nullable) = false];
}
